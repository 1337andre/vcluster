version: v1beta9
images:
  vcluster:
    image: ghcr.io/loft-sh/loft-enterprise/dev-vcluster
    preferSyncOverRebuild: true
    entrypoint: ["sleep", "99999999"]
    build:
      docker:
        skipPush: true
        options:
          target: builder
deployments:
  - name: vcluster
    helm:
      chart:
        name: ./chart
      values:
        rbac:
          clusterRole:
            create: true
        syncer:
          image: ghcr.io/loft-sh/loft-enterprise/dev-vcluster
          noArgs: true
dev:
  interactive:
    defaultEnabled: true
  sync:
    - imageName: vcluster
      disableDownload: true
      waitInitialSync: true
      excludePaths:
        - bin/
        - .vscode/
        - .idea/
        - .git/
        - docs/
        - examples/
        - /chart
        - /helm
        - /kubectl
        - /vendor/github.com/devspace-cloud/
commands:
  - name: dev
    command: "devspace dev -n vcluster"
  - name: deploy
    command: "devspace deploy --profile deploy -n vcluster -d"
profiles:
  - name: deploy
    replace:
      images:
        vcluster:
          image: ghcr.io/loft-sh/loft-enterprise/dev-vcluster
      deployments:
        - name: vcluster
          helm:
            chart:
              name: ./chart
            values:
              serviceAccount:
                create: false
                name: default
              vcluster:
                image: rancher/k3s:v1.20.5-k3s1
                extraArgs:
                  - --service-cidr=10.108.0.0/20
              rbac:
                clusterRole:
                  create: true
              syncer:
                image: ghcr.io/loft-sh/loft-enterprise/dev-vcluster
                extraArgs:
                  - --sync-all-nodes
                  - --sync-node-changes
                  - --fake-nodes=false
