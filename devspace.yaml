version: v1beta10
vars:
  - name: IMAGE
    value: ghcr.io/loft-sh/loft-enterprise/dev-vcluster
  - name: K3S
    value: rancher/k3s:v1.20.5-k3s1
  - name: SERVICE_CIDR
    value: 10.96.0.0/12
images:
  vcluster:
    image: ${IMAGE}
    rebuildStrategy: ignoreContextChanges
    entrypoint: ["sleep", "999999999"]
    build:
      docker:
        skipPush: true
        options:
          target: builder
deployments:
  - name: vcluster
    helm:
      chart:
        name: ./chart
      values:
        serviceAccount:
          create: false
          name: default
        vcluster:
          image: ${K3S}
          extraArgs:
            - --service-cidr=${SERVICE_CIDR}
        rbac:
          clusterRole:
            create: true
        syncer:
          readinessProbe:
            enabled: false
          livenessProbe:
            enabled: false
          image: ${IMAGE}
          noArgs: true
dev:
  terminal:
    imageSelector: ${IMAGE}
  sync:
    - imageSelector: ${IMAGE}
      excludePaths:
        - '**'
        - '!/pkg'
        - '!/cmd'
        - '!/vendor'
        - '!/go.mod'
        - '!/go.sum'
commands:
  - name: dev
    command: "devspace dev -n vcluster"
  - name: deploy
    command: "devspace deploy --profile deploy -n vcluster -d"
profiles:
  - name: deploy
    replace:
      images:
        vcluster:
          image: ${IMAGE}
      deployments:
        - name: vcluster
          helm:
            chart:
              name: ./chart
            values:
              vcluster:
                image: ${K3S}
                extraArgs:
                  - --service-cidr=${SERVICE_CIDR}
              syncer:
                image: ${IMAGE}
