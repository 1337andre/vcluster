version: v1beta10
images:
  vcluster:
    image: ghcr.io/loft-sh/loft-enterprise/dev-vcluster
    rebuildStrategy: ignoreContextChanges
    entrypoint: ["sleep", "99999999"]
    build:
      docker:
        skipPush: true
        options:
          target: builder
deployments:
  - name: vcluster
    helm:
      chart:
        name: ./chart
      values:
        serviceAccount:
          create: false
          name: default
        vcluster:
          image: rancher/k3s:v1.20.5-k3s1
          extraArgs:
            - --service-cidr=10.68.0.0/20
        rbac:
          clusterRole:
            create: true
        syncer:
          image: ghcr.io/loft-sh/loft-enterprise/dev-vcluster
          noArgs: true
dev:
  terminal:
    imageName: vcluster
  sync:
    - imageName: vcluster
      disableDownload: true
      waitInitialSync: true
      excludePaths:
        - bin/
        - .vscode/
        - .idea/
        - .git/
        - docs/
        - examples/
        - /conformance
        - /hack
        - /test
        - /chart
        - /helm
        - /kubectl
        - /vendor/github.com/devspace-cloud/
commands:
  - name: dev
    command: "devspace dev -n vcluster"
  - name: gke
    command: "devspace dev -n vcluster -p gke"
  - name: deploy
    command: "devspace deploy --profile deploy -n vcluster -d"
profiles:
  - name: gke
    patches:
      - path: dev.terminal
        op: replace
        value:
          containerName: syncer
          labelSelector:
            app: vcluster
      - path: dev.replacePods
        op: replace
        value:
          - labelSelector:
              app: vcluster
            containerName: syncer
            replaceImage: golang:1.16
            patches:
              - path: spec.containers[1].workingDir
                op: replace
                value: /vcluster
              - path: spec.containers[1].command
                op: replace
                value: ["sleep", "99999999999"]
      - path: dev.sync[0].imageName
        op: remove
      - path: images.vcluster
        op: remove
      - path: dev.sync[0].containerName
        op: replace
        value: syncer
      - path: dev.sync[0].labelSelector
        op: replace
        value:
          app: vcluster
  - name: deploy
    replace:
      images:
        vcluster:
          image: ghcr.io/loft-sh/loft-enterprise/dev-vcluster
      deployments:
        - name: vcluster
          helm:
            chart:
              name: ./chart
            values:
              serviceAccount:
                create: false
                name: default
              vcluster:
                image: rancher/k3s:v1.20.5-k3s1
                extraArgs:
                  - --service-cidr=10.68.0.0/20
              rbac:
                clusterRole:
                  create: true
              syncer:
                image: ghcr.io/loft-sh/loft-enterprise/dev-vcluster
                extraArgs: []
