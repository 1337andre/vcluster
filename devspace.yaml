version: v1beta11
vars:
  - name: SYNCER_IMAGE
    value: ghcr.io/loft-sh/loft-enterprise/dev-vcluster
  - name: K3S_IMAGE
    value: rancher/k3s:v1.21.2-k3s1
  # Replace this with your clusters service CIDR, you can find it out via
  # kubectl apply -f hack/wrong-cluster-ip-service.yaml
  - name: SERVICE_CIDR
    value: 10.96.0.0/12
images:
  vcluster:
    image: ${SYNCER_IMAGE}
    rebuildStrategy: ignoreContextChanges
    build:
      buildKit:
        options:
          target: builder
deployments:
  - name: vcluster
    helm:
      chart:
        name: ./chart
      values:
        tolerations:
          - operator: "Exists"
        serviceAccount:
          create: false
          name: default
        vcluster:
          image: ${K3S_IMAGE}
          extraArgs:
            - --service-cidr=${SERVICE_CIDR}
        rbac:
          clusterRole:
            create: true
        syncer:
          readinessProbe:
            enabled: false
          livenessProbe:
            enabled: false
          image: ${SYNCER_IMAGE}
          noArgs: true
          workingDir: /vcluster
          command: ["sleep"]
          extraArgs: ["99999999999"]
        securityContext:
          readOnlyRootFilesystem: false
dev:
  terminal:
    imageSelector: ${SYNCER_IMAGE}
    command: ["./devspace_start.sh"]
  ports:
    - imageSelector: ${SYNCER_IMAGE}
      forward:
        - port: 2346
          remotePort: 2345
  sync:
    - imageSelector: ${SYNCER_IMAGE}
      excludePaths:
        - '**'
        - '!/pkg'
        - '!/cmd'
        - '!/vendor'
        - '!/hack'
        - '!/manifests'
        - '!/go.mod'
        - '!/go.sum'
        - '!/devspace_start.sh'
commands:
  - name: dev
    command: "devspace dev -n vcluster $@"
  - name: dev-crc
    command: "devspace dev -n vcluster --profile dev-crc $@"
  - name: deploy
    command: "devspace deploy --profile deploy -n vcluster -d $@"
  - name: deploy-crc
    command: "devspace deploy --profile deploy-crc -n vcluster -d $@"
profiles:
  - name: parent-deploy
    patches:
      - op: remove
        path: deployments.name=vcluster.helm.values.syncer.command
      - op: remove
        path: deployments.name=vcluster.helm.values.syncer.extraArgs
  - name: deploy
    parents: 
      - profile: parent-deploy
    patches:
      - op: remove
        path: images.vcluster.rebuildStrategy
      - op: replace
        path: images.vcluster.build.buildKit
        value: {}
      - op: replace
        path: deployments.name=vcluster.helm.values.syncer
        value:
          image: ${SYNCER_IMAGE}
  - name: parent-crc
    patches:
      - op: replace
        path: images.vcluster.build.custom
        value:
          command: ./hack/crc-podman-build.sh
          imageFlag: "-t"
      - op: replace
        path: deployments.name=vcluster.helm.values.openshift
        value: 
          enable: true
  - name: deploy-crc
    parents: 
      - profile: parent-deploy
      - profile: parent-crc
  - name: dev-crc
    parents: 
      - profile: parent-crc
    patches:
      - op: replace
        path: images.vcluster.build.custom.args
        value: 
         - "--target=builder"
